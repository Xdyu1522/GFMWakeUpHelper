<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:suki="clr-namespace:SukiUI.Controls;assembly=SukiUI"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:GFMWakeUpHelper.App.Features.SongManageView"
    xmlns:models="using:GFMWakeUpHelper.Data.Entities"
    d:DataContext="{d:DesignInstance Type=vm:SongManageViewModel}"
    mc:Ignorable="d"
    x:Class="GFMWakeUpHelper.App.Features.SongManageView.SongManageView"
    x:DataType="vm:SongManageViewModel"
    x:Name="SongManageViewControl"
    Padding="16"
    Background="{DynamicResource SukiBackgroundBrush}">

    <DockPanel>
        <!-- ===== 顶部：搜索栏 + 工具栏 ===== -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
            <!-- 搜索区域 -->
            <TextBox
                Width="250"
                Watermark="请输入关键字搜索"
                Text="{Binding SearchText, Mode=TwoWay}" />

            <ComboBox
                Width="150"
                ItemsSource="{Binding SearchFields}"
                SelectedValue="{Binding SelectedField, Mode=TwoWay}" />

            <Button
                Content="刷新"
                Command="{Binding RefreshCommand}"
                ToolTip.Tip="重新加载歌曲列表，会清空命令历史" />

            <!-- 操作按钮组 -->
            <Button
                Classes="Danger"
                Content="删除"
                Command="{Binding DeleteSongCommand}"
                ToolTip.Tip="删除选中的歌曲" />

            <Button
                Content="撤销"
                Command="{Binding UndoCommand}"
                ToolTip.Tip="撤销上一次修改操作" />

            <Button
                Content="复制"
                Command="{Binding CopySongCommand}"
                ToolTip.Tip="复制当前选中歌曲信息" />

            <!-- 检查重复歌曲 -->
            <Button
                Content="检查重复歌曲"
                Command="{Binding CheckDuplicateCommand}"
                ToolTip.Tip="检查列表中是否存在重复歌曲" />

            <!-- 右侧空隙推送 -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right">
                <TextBlock
                    VerticalAlignment="Center"
                    Text="{Binding RecordCount, StringFormat='共 {0} 条记录'}"
                    Foreground="{DynamicResource SukiTextSecondaryBrush}"
                    FontSize="13"
                    Margin="8,0,0,0" />
            </StackPanel>
        </StackPanel>


        <!-- ===== 中间：DataGrid 数据表 ===== -->
        <suki:GlassCard DockPanel.Dock="Top" Padding="8" CornerRadius="8" VerticalAlignment="Stretch">
            <DataGrid
                ItemsSource="{Binding Songs}"
                SelectedItem="{Binding SelectedSong, Mode=TwoWay}"
                AutoGenerateColumns="False"
                CanUserResizeColumns="True"
                IsReadOnly="False"
                HeadersVisibility="Column"
                GridLinesVisibility="Horizontal"
                RowBackground="{DynamicResource SukiCardBackgroundBrush}"
                Margin="0,0,0,8"
                x:Name="ShowSongsDataGrid">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True" Width="5*" />
                    <!--
                    <DataGridTextColumn Header="标题" Binding="{Binding Title, Mode=OneWay}" Width="10*" />
                    -->
                    <DataGridTemplateColumn Header="标题" Width="10*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="vm:SongViewModel">
                                <TextBox Tag="{Binding}"
                                         Text="{Binding Title, Mode=TwoWay, UpdateSourceTrigger=Explicit}"
                                         Margin="5,0,0,5"
                                         LostFocus="TitleColumn_LostFocus" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="歌手"
                                        Binding="{Binding Artists, Mode=TwoWay, Converter={StaticResource ListStringToVisibilityConverter}}"
                                        Width="10*" />
                    <DataGridTextColumn Header="添加批次"
                                        Binding="{Binding Batch}"
                                        IsReadOnly="True"
                                        Width="6*" />
                    <DataGridTextColumn Header="添加日期"
                                        Binding="{Binding RequestedAt, Mode=TwoWay, Converter={StaticResource DateTimeToVisibilityConverter}}"
                                        Width="6*" />
                    <!--<DataGridCheckBoxColumn Header="是否可用"
                                            Binding="{Binding IsActive, Mode=OneWay}"
                                            Width="5*" />-->
                    <DataGridTemplateColumn Header="是否可用" Width="5*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="vm:SongViewModel">
                                <CheckBox Tag="{Binding .}"
                                          IsChecked="{Binding IsActive, Mode=TwoWay}"
                                          IsCheckedChanged="IsActiveChanged" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                </DataGrid.Columns>

            </DataGrid>
        </suki:GlassCard>

        <!-- ===== 底部：提交修改按钮 ===== -->
        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button
                Classes="Flat"
                Content="提交修改"
                Command="{Binding SubmitChangesCommand}"
                Width="140" Height="36" />
        </StackPanel>
    </DockPanel>
</UserControl>